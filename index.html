<!doctype html>
 <html>
  <head>
   <meta charset='utf-8'>
   <meta content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'>
   <script src='lodash/4.17.12.min.js'></script>
   <script src='faker/4.1.0.min.js'></script>
   <script src='d3/5.9.2.min.js'></script>
   <script>
     window.addEventListener('load',function(){

      var gunDB = {
        archive:{
        }
      }

      function gunDBcreate(num){

        for(var i=0;i<num;i++)
        {
          var uuid = faker.random.uuid()
          var firstName = faker.name.firstName()

          gunDB.archive[uuid] = []

          var range = faker.random.number({ max:365, min:1 })
          for(var n=0;n<range;n++){
            gunDB.archive[uuid].push({
                name:firstName,
                bed:faker.random.number({ max:50, min:0 }),
                bath:faker.random.number({ max:32, min:0 }),
                check:faker.random.number({ max:24, min:12 }),
              })
            }
          }

      }

      function gunDBprint(key){
        console.log(_.map(gunDB.archive[key],'bed'))
        console.log(_.map(gunDB.archive[key],'bath'))
        console.log(_.map(gunDB.archive[key],'check'))
      }

      var margin ={
        top:10,
        left:10,
        right:10,
        bottom:10,
      }

      var padding ={
        top:30,
        left:70,
        right:10,
        bottom:30,
      }

      console.dir(document.body)
      console.dir(document.body.clientWidth)
      console.dir(document.body.clientHeight)

      gunDBcreate(140)
      gunDB//print('GA1.1.1991240896.1555964592')


      var
        outerWidth  = document.body.clientWidth,
        outerHeight = _.keys(gunDB.archive).length * 30,
        innerWidth  = outerWidth  - (margin.left + margin.right),
        innerHeight = outerHeight - (margin.top + margin.bottom),
        width       = innerWidth  - (padding.left + padding.right),
        height      = innerHeight - (padding.top + padding.bottom);


      var
        svg,
        area,
        chart

      function init()
      {
        svg = d3.select('#view')
                .attr('width', outerWidth)
                .attr('height',outerHeight)
        area = svg.append('g')
                .attr('transform','translate(' + margin.left + ',' + margin.top + ')')
        chart = area.append("g")
                .attr('transform','translate(' + padding.left + ',' + padding.top + ')')
      }

      init()

      var
        users,
        usersCount

      function construct()
      {
        users = _.keys(gunDB.archive)
        usersCount = users.length
      }

      construct()

      var
        xAxis,
        yAxis
      var
        yName
      var maxTaskCount = 70
      
      function axisInit()
      {
        xAxis = d3.scaleLinear()
                  .domain([-10, maxTaskCount])
                  .range([ 0, width ]);      
        yAxis = d3.scaleLinear()
                  .domain([0,1.0])
                  .range([height,0])          
      }

      function nameInit()
      {
        yName = d3.scaleBand()
                  .domain(users)
                  .range([0, height])
                  .paddingInner(1)
      }

      axisInit()
      nameInit()

      function draw()
      {
        // area.append('rect')
        //     .attr('class','outer')
        //     .attr('width', innerWidth)
        //     .attr('height',innerHeight)
        // chart.append('rect')
        //     .attr('class','inner')
        //     .attr('width',  width)
        //     .attr('height', height)
        chart.append("g")
            .attr('class','grid')
            .attr('transform','translate(0,' + height + ')')
            .call(d3.axisBottom(xAxis).tickSize(-height))
        chart.append('g')
            .attr('class','grid')
            .call(d3.axisLeft(yName).tickSize(-width).tickFormat(function(id){
              return gunDB.archive[id][0].name
            }))
      }

      draw()

      function kernelDensityEstimator(kernel, X) {
        return function(V) {
          return X.map(function(x) {
            return [x, d3.mean(V, function(v) { return kernel(x - v); })];
          })
        }
      }
      function kernelEpanechnikov(k) {
        return function(v) {
          return Math.abs(v /= k) <= 1 ? 30 / _.keys(gunDB.archive).length * 0.25 * (1 - v * v) / k : 0;
        }
      }

      function insert(task)
      {
        var kde = kernelDensityEstimator(kernelEpanechnikov(7), xAxis.ticks(40))
        var allDensity = []
        for (i = 0; i < usersCount; i++) {
            key = users[i]
            values = _.map(gunDB.archive[key],task)
            density = kde( values )
            allDensity.push({key: key, density: density})
        }
      
        // Add areas
        chart.selectAll('areas')
          .data(allDensity)
          .enter()
          .append('path')
            .attr('transform', function(d){
              return('translate(0,' + (yName(d.key)-height) +')' )})
            .datum(function(d){
              return(d.density)})
            .attr('class',task)
            .attr('d',  d3.line()
              .curve(d3.curveBasis)
              .x(function(d) {
                return xAxis(d[0]); })
              .y(function(d) {
                return yAxis(d[1]); })
            )
      }

      insert('bed')
      insert('bath')
      insert('check')

     })
      
      </script>
       <style>
html,
body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  display:block;
}
svg rect.outer{
  fill:none;
  stroke:black;
}
svg rect.inner{
  fill:none;
  stroke:black;
  stroke-dasharray:3,4;
}

path{
  opacity:0.726;
  stroke:'black';
  stroke-width:0.3;
}
path.bed{
  fill:#fbbd08;
}
path.bath{
  fill:#2185d0;
}
path.check{
  fill:#21ba45;
}
text{
  font-size:12px;
}
.grid line {
  stroke: lightgrey;
  stroke-width:1;
  stroke-opacity: 0.7;
  shape-rendering: crispEdges;
}

      </style>
 </head>
  <body>
   <svg id="view"></svg>
 </body>
</html>